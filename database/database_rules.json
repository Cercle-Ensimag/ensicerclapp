{
  "rules": {
    "users": {
      ".read": "(auth.token.email === root.child('admin/public/admins/admin1').val() ||
                 auth.token.email === root.child('admin/public/admins/admin2').val() ||
                 auth.token.email === root.child('admin/public/admins/admin3').val()) &&
                auth.token.email_verified == true",

      "$emailId": {
        "votes": {
          ".read": "auth.token.email_verified == true &&
                    auth.token.email.endsWith('@ensimag.fr') &&
                    $emailId === auth.token.email.replace('@ensimag.fr', '').replace('.', '|')",
          "$poll_id": {
            ".write": "((auth.token.email_verified == true &&
                         auth.token.email.endsWith('@ensimag.fr') &&
                         $emailId === auth.token.email.replace('@ensimag.fr', '').replace('.', '|')) ||
                        (auth.token.email_verified == true &&
                         root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/assessor').val() == true)) &&
                       root.child('vote/polls/'+$poll_id+'/started').val() == true",
            ".validate": "root.child('vote/polls/'+$poll_id).exists() &&
                          newData.isBoolean() && newData.val() == true &&
                          (root.child('vote/users/'+$poll_id+'/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/voted').exists() &&
                           root.child('vote/users/'+$poll_id+'/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/voted').val() == true)"
          }
        },
        "uid": { ".validate": "newData.val() === auth.uid" },
        "$user": {
          ".read": "$user === auth.uid",

          "admin": {
            ".write": "(auth.token.email === root.child('admin/public/admins/admin1').val() ||
                        auth.token.email === root.child('admin/public/admins/admin2').val() ||
                        auth.token.email === root.child('admin/public/admins/admin3').val()) &&
                       auth.token.email_verified == true",

            "email": {
              ".validate": "newData.isString() && newData.val().contains('@ensimag.fr') &&
                            auth.token.email === newData.val() &&
                            !data.exists()"
            },
            "cafet-admin": { ".validate": "newData.isBoolean()" },
            "events-admin": { ".validate": "newData.isBoolean()" },
            "vote-admin": { ".validate": "newData.isBoolean()" },

            "$other": { ".validate": false }
          },
          "account": {
            ".write": "$user === auth.uid",

            "name": {
              ".validate": "newData.hasChildren(['firstName', 'lastName'])",

              "firstName": { ".validate": "newData.isString()" },
              "lastName": { ".validate": "newData.isString()" },
              "login": { ".validate": "newData.isString()" },

              "$other": { ".validate": false }
            },
            "photoURL": { ".validate": "newData.isString()" },

            "$other": { ".validate": false }
          },

          "$other": { ".validate": false }
        }
      }
    },
    "admin": {
      "public": {
        ".read": "auth.token.email_verified == true &&
                  auth.token.email.endsWith('@ensimag.fr')",

        "admins": {
          "$email": { ".validate": "newData.isString() && newData.val().endsWith('@ensimag.fr')" },
        },

        "modules": {
          "$module": {
            "name": { ".validate": "newData.isString()" },
            "disabled": {".validate": "newData.isBoolean()" },

            "$other": { ".validate": false }
          }
        },

        "$other": { ".validate": false }
      },
      "private": {
        "$other": { ".validate": false }
      },

      "$other": { ".validate": false }
    },
    "cafet": {
      ".read": "auth.token.email_verified == true &&
                root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/cafet-admin').val() == true",
      ".write": "auth.token.email_verified == true &&
                 root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/cafet-admin').val() == true",

      "users": {
        "$emailId": {
          ".read": "auth.token.email_verified == true &&
                    auth.token.email.endsWith('@ensimag.fr') &&
                    $emailId === auth.token.email.replace('@ensimag.fr', '').replace('.', '|')",

          "emailId": {
            ".write": "auth.token.email_verified == true &&
                       auth.token.email.endsWith('@ensimag.fr') &&
                       $emailId === auth.token.email.replace('@ensimag.fr', '').replace('.', '|')",
            ".validate": "newData.val() === $emailId"
          },
          "activated": { ".validate": "newData.isBoolean()" },
          "credit": { ".validate": "newData.isNumber()" },

          "$other": { ".validate": false }
        },
      },
      "history": {
        "$emailId": {
          ".read": "auth.token.email_verified == true &&
                    auth.token.email.endsWith('@ensimag.fr') &&
                    $emailId === auth.token.email.replace('@ensimag.fr', '').replace('.', '|')",

          "$transaction": {
            "value": { ".validate": "newData.isNumber()" },
            "newCredit": { ".validate": "newData.isNumber()" },
            "oldCredit": { ".validate": "newData.isNumber()" }
          }
        }
      },
      "public": {
        ".read": "auth.token.email_verified == true &&
                  auth.token.email.endsWith('@ensimag.fr')",

        "ingredients": {
          "groups": {
            "$group": { ".validate": "newData.isString()" }
          },
          "individual": {
            "$ingredient" : {
              "name": { ".validate": "newData.isString()" },
              "group": { ".validate": "newData.isString()" },
              "alias": { ".validate": "newData.isString()" },
              "image": { ".validate": "newData.isString()" },

              "$other": { ".validate": false }
            }
          },
          "recipes": {
            "$recipe": {
              "$ingredient": { ".validate": "newData.isString()" }
            }
          }
        },
        "info": {
          "service-opened": { ".validate": "newData.isBoolean()" },
          "service-canceled": { ".validate": "newData.isBoolean()" },
          "cancel-message": { ".validate": "newData.isString()" },
          "day": { ".validate": "newData.isString()" },

          "$other": { ".validate": false }
        },

        "$other": { ".validate": false }
      },

      "$other": { ".validate": false }
    },
    "calendar": {

    },
    "events": {
      ".read": "auth.token.email_verified == true &&
                auth.token.email.endsWith('@ensimag.fr')",
      "$eventId": {
        ".write": "auth.token.email_verified == true &&
                   root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/events-admin').val() == true &&
                   newData.child('author').val() === auth.token.email.replace('@ensimag.fr', '').replace('.', '|')",
        "id": { ".validate": "newData.val() === $eventId" },
        "title": { ".validate": "newData.isString()" },
        "description": { ".validate": "newData.isString()" },
        "image": { ".validate": "newData.isString()" },
        "start": { ".validate": "newData.isBoolean()" },
        "end": { ".validate": "newData.isBoolean()" },
        "author": { ".validate": "newData.val() === auth.token.email.replace('@ensimag.fr', '').replace('.', '|')"},

        "$other": { ".validate": false }
      }
    },
    "vote": {
      "assessors": {
        ".read": "(auth.token.email === root.child('admin/public/admins/admin1').val() ||
                   auth.token.email === root.child('admin/public/admins/admin2').val() ||
                   auth.token.email === root.child('admin/public/admins/admin3').val() ||
                   root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true) &&
                  auth.token.email_verified == true",
        ".write": "(auth.token.email === root.child('admin/public/admins/admin1').val() ||
                    auth.token.email === root.child('admin/public/admins/admin2').val() ||
                    auth.token.email === root.child('admin/public/admins/admin3').val() ||
                    root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true) &&
                   auth.token.email_verified == true",
        "$emailId": {
          "emailId": { ".validate": "newData.val() === $emailId ||Â !newData.exists()" },
        }
      },
      "polls": {
        ".read": "auth.token.email_verified == true &&
                  auth.token.email.endsWith('@ensimag.fr')",
        ".write": "auth.token.email_verified == true &&
                   root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true",

        "$poll_id": {
          ".validate": "newData.hasChildren(['title', 'description'])",

          "id": { ".validate": "newData.val() === $poll_id" },
          "title": { ".validate": "newData.isString()" },
          "description": { ".validate": "newData.isString()" },
          "started": { ".validate": "newData.isBoolean()" },
          "choices": {
            "$choice_id": {
              ".validate": "newData.hasChildren(['id', 'label'])",

              "id": { ".validate": "newData.val() === $choice_id" },
              "label": { ".validate": "newData.isString()" },
              "short": { ".validate": "newData.isString()" },
              "image": { ".validate": "newData.isString()" },

              "$other": { ".validate": false }
            }
          },

          "$other": { ".validate": false }
        },
      },
      "users": {
        "$poll_id": {
          ".read": "auth.token.email_verified == true &&
                    (root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true ||
                     root.child('vote/assessors/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists())",
          ".write": "auth.token.email_verified == true &&
                     root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true &&
                     !newData.exists()",
          ".validate": "root.child('vote/polls/'+$poll_id).exists()",

          "$emailId": {
            ".write": "auth.token.email_verified == true &&
                       root.child('vote/assessors/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists() &&
                       root.child('vote/polls/'+$poll_id+'/started').val() == true",
            ".validate": "newData.hasChildren(['emailId', 'voted'])",

            "emailId": {
              ".write": "auth.token.email_verified == true &&
                         auth.token.email.endsWith('@ensimag.fr') &&
                         $emailId === auth.token.email.replace('@ensimag.fr', '').replace('.', '|') &&
                         root.child('vote/polls/'+$poll_id+'/started').val() == true",
              ".validate": "newData.val() === $emailId"
            },
            "voted": {
              ".write": "auth.token.email_verified == true &&
                         auth.token.email.endsWith('@ensimag.fr') &&
                         $emailId === auth.token.email.replace('@ensimag.fr', '').replace('.', '|') &&
                         root.child('vote/polls/'+$poll_id+'/started').val() == true &&
                         (!data.exists() || data.val() != true) &&
                         newData.val() == true",
              ".validate": "newData.isBoolean()"

            },

            "$other": { ".validate": false }
          }
        },
      },
      "results": {
        "$poll_id": {
          ".write": "auth.token.email_verified == true &&
                     root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true &&
                     !newData.exists()",
          ".validate": "root.child('vote/polls/'+$poll_id).exists()",

          "buffer": {
            "$emailId": {
              ".write": "auth.token.email_verified == true &&
                         auth.token.email.endsWith('@ensimag.fr') &&
                         $emailId === auth.token.email.replace('@ensimag.fr', '').replace('.', '|') &&
                         root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid).exists() &&
                         (!root.child('vote/users/'+$poll_id+'/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/voted').exists() ||
                          (root.child('vote/users/'+$poll_id+'/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/voted').val() != true)) &&
                         root.child('vote/polls/'+$poll_id+'/started').val() == true",
              ".validate": "root.child('vote/polls/'+$poll_id+'/choices/'+newData.val()).exists()"
            }
          },
          "ballot_box": {
            ".read": "auth.token.email_verified == true &&
                      root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true &&
                      root.child('vote/polls/'+$poll_id+'/started').val() == false",
            "$choice_id": {
              ".validate": "root.child('vote/polls/'+$poll_id+'/choices/'+$choice_id).exists()",
              "$paper": { ".validate": "!data.exists() && (newData.val() == true)"}
            }
          },

          "$other": { ".validate": false }
        }
      },

      "$other": { ".validate": false }
    },
    "list": {
        "update": { ".validate": "newData.isNumber()" },
        "users": {
            ".read": "auth.token.email_verified == true &&
                      (auth.token.email === root.child('admin/public/admins/admin1').val() ||
                       auth.token.email === root.child('admin/public/admins/admin2').val() ||
                       auth.token.email === root.child('admin/public/admins/admin3').val() ||
                       root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true ||
                       root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/cafet-admin').val() == true) ||,
                       root.child('vote/assessors/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists()",
            "$emailId": { ".validate": "newData.isNumber()" }
        }
    },

    "$other": { ".validate": false }
  }
}
