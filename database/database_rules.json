{
  "rules": {
    "users": {
      ".read": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                 auth.token.email === root.child('admin/private/admins/admin2').val() ||
                 auth.token.email === root.child('admin/private/admins/admin3').val()) &&
                auth != null && auth.token.email_verified == true",

      "$emailId": {
        "uid": { ".validate": "newData.val() === auth.uid" },
        "$user": {
          ".read": "$user === auth.uid",

          "admin": {
            ".write": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                        auth.token.email === root.child('admin/private/admins/admin2').val() ||
                        auth.token.email === root.child('admin/private/admins/admin3').val()) &&
                       auth != null && auth.token.email_verified == true",

            "email": {
              ".validate": "newData.val() === root.child('list/users/'+$emailId).val()"
            },
            "cafet-admin": { ".validate": "newData.isBoolean()" },
            "events-admin": { ".validate": "newData.isBoolean()" },
            "actus-admin": { ".validate": "newData.isBoolean()" },
            "vote-admin": { ".validate": "newData.isBoolean()" },

            "$other": { ".validate": false }
          },
          "account": {
            ".write": "$user === auth.uid",

            "name": {
              ".validate": "newData.hasChildren(['firstName', 'lastName'])",

              "firstName": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "lastName": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "login": { ".validate": "newData.isString() && newData.val().length <= 30" },

              "$other": { ".validate": false }
            },
            "photoURL": { ".validate": "newData.isString() && newData.val().length <= 500" },

            "$other": { ".validate": false }
          },

          "$other": { ".validate": false }
        }
      }
    },
    "admin": {
      "public": {
        ".read": "auth != null && auth != null && auth.token.email_verified == true",

        "modules": {
          "$module": {
            "name": { ".validate": "newData.isString() && newData.val().length <= 30" },
            "disabled": {".validate": "newData.isBoolean()" },

            "$other": { ".validate": false }
          }
        },

        "$other": { ".validate": false }
      },
      "private": {
        ".read": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                   auth.token.email === root.child('admin/private/admins/admin2').val() ||
                   auth.token.email === root.child('admin/private/admins/admin3').val()) &&
                  auth != null && auth.token.email_verified == true",
        "admins": {
          "$email": { ".validate": "newData.isString() && newData.val().endsWith('@ensimag.fr')" },
        },
        "$other": { ".validate": false }
      },

      "$other": { ".validate": false }
    },
    "actus": {
      "journalists": {
        ".read": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                   auth.token.email === root.child('admin/private/admins/admin2').val() ||
                   auth.token.email === root.child('admin/private/admins/admin3').val() ||
                   root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/actus-admin').val() == true ||
                   root.child('actus/journalists/users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists()) &&
                  auth != null && auth.token.email_verified == true",
        ".write": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                    auth.token.email === root.child('admin/private/admins/admin2').val() ||
                    auth.token.email === root.child('admin/private/admins/admin3').val() ||
                    root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/actus-admin').val() == true) &&
                   auth != null && auth.token.email_verified == true",
        "groups": {
          "$groupId": {
            "groupId": { ".validate": "newData.isString() && newData.val().length <= 30" },
            "displayName": { ".validate": "newData.isString() && newData.val().length <= 30" }
          }
        },
        "users": {
          "$emailId": {
            "emailId": { ".validate": "newData.val() === $emailId || !newData.exists()" },
            "groupId": { ".validate": "root.child('actus/journalists/groups/'+newData.val()).exists()" }
          }
        },

        "$other": { ".validate": false }
      },
      "actus": {
        ".read": "auth != null && auth.token.email_verified == true",

        "$actuId": {
          ".write": "auth != null && auth.token.email_verified == true &&
                     (root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/actus-admin').val() == true ||
                      root.child('actus/journalists/users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists()) &&
                     (root.child('actus/journalists/users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/groupId').val() === newData.child('groupId').val() ||
                      !newData.exists())",

          "id": { ".validate": "newData.val() === $actuId" },
          "title": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "description": { ".validate": "newData.isString() && newData.val().length <= 2000" },
          "image": { ".validate": "newData.isString() && newData.val().length <= 500" },
          "date": { ".validate": "newData.isString() && newData.val().length <= 50" },
          "author": { ".validate": "newData.isString() && newData.val().length <= 50" },
          "groupId": {
            ".validate": "root.child('actus/journalists/users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/groupId').val() === data.val() ||
                          !data.exists()"
          },

          "$other": { ".validate": false }
        }
      },

      "$other": { ".validate": false }
    },
    "cafet": {
      ".read": "auth != null && auth.token.email_verified == true &&
                root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/cafet-admin').val() == true",
      ".write": "auth != null && auth.token.email_verified == true &&
                 root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/cafet-admin').val() == true",

      "cafetResps": {
        ".read": "root.child('cafet/cafetResps/users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists() &&
             auth != null && auth.token.email_verified == true",

        "users": {
          "$emailId": {
            "emailId": { ".validate": "newData.val() === $emailId || !newData.exists()" }
          }
        },

        "$other": { ".validate": false }
      },
      "users": {
        "$emailId": {
          ".read": "auth != null && auth.token.email_verified == true &&
                    root.child('list/users/'+$emailId).val() === auth.token.email",

          "emailId": { ".validate": "newData.val() === $emailId" },
          "activated": { ".validate": "newData.isBoolean()" },
          "credit": { ".validate": "newData.isNumber()" },
          "creationDate": { ".validate": "newData.isNumber()" },
          "lastTransactionDate": { ".validate": "newData.isNumber()" },
          "profile": {
            ".validate": "newData.hasChildren(['firstName', 'lastName'])",

            "firstName": { ".validate": "newData.isString() && newData.val().length <= 30" },
            "lastName": { ".validate": "newData.isString() && newData.val().length <= 30" },
            "email": { ".validate": "newData.isString() && newData.val().length <= 50" },
            "exte": { ".validate": "newData.isBoolean()" },

            "$other": { ".validate": false }
          },

          "$other": { ".validate": false }
        }
      },
      "archives": {
        "users": {
          "$emailId": {
            ".read": "auth != null && auth.token.email_verified == true &&
                      root.child('list/users/'+$emailId).val() === auth.token.email",

            "emailId": { ".validate": "newData.val() === $emailId" },
            "activated": { ".validate": "newData.isBoolean()" },
            "credit": { ".validate": "newData.isNumber()" },
            "creationDate": { ".validate": "newData.isNumber()" },
            "lastTransactionDate": { ".validate": "newData.isNumber()" },
            "profile": {
              ".validate": "newData.hasChildren(['firstName', 'lastName'])",

              "firstName": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "lastName": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "email": { ".validate": "newData.isString() && newData.val().length <= 50" },
              "exte": { ".validate": "newData.isBoolean()" },

              "$other": { ".validate": false }
            },

            "$other": { ".validate": false }
          }
        },

        "$other": { ".validate": false }
      },
      "history": {
        "$emailId": {
          ".read": "auth != null && auth.token.email_verified == true &&
                    root.child('list/users/'+$emailId).val() === auth.token.email",

          "$transaction": {
            "value": { ".validate": "newData.isNumber() && newData.val() <= 1000 && newData.val() >= -1000" },
            "newCredit": { ".validate": "newData.isNumber()" },
            "oldCredit": { ".validate": "newData.isNumber()" },
            "date": { ".validate": "newData.isNumber()" },

            "$other": { ".validate": false }
          }
        }
      },
      "public": {
        ".read": "auth != null && auth.token.email_verified == true",

        "ingredients": {
          "groups": {
            "$group": { ".validate": "newData.isString() && newData.val().length <= 30" }
          },
          "individual": {
            "$ingredient" : {
              "name": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "group": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "alias": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "image": { ".validate": "newData.isString() && newData.val().length <= 500" },

              "$other": { ".validate": false }
            }
          },
          "recipes": {
            "$recipe": {
              "$ingredient": { ".validate": "newData.isString() && newData.val().length <= 30" }
            }
          }
        },
        "info": {
          "service-opened": { ".validate": "newData.isBoolean()" },
          "service-canceled": { ".validate": "newData.isBoolean()" },
          "cancel-message": { ".validate": "newData.isString() && newData.val().length <= 200" },
          "day": { ".validate": "newData.isNumber()" },

          "$other": { ".validate": false }
        },

        "$other": { ".validate": false }
      },

      "$other": { ".validate": false }
    },
    "calendar": {
      "users": {
        "$emailId": {
          "settings": {
            ".read": "auth != null && auth.token.email_verified == true &&
                      root.child('list/users/'+$emailId).val() === auth.token.email",
            ".write": "auth != null && auth.token.email_verified == true &&
                       root.child('list/users/'+$emailId).val() === auth.token.email",
            "resources": { ".validate": "newData.val().matches(/^[0-9]+(,[0-9])*/)" },

            "$other": { ".validate": false }
          },
          "assos": {
            ".read": "auth != null && auth.token.email_verified == true &&
                      root.child('list/users/'+$emailId).val() === auth.token.email",
            "$eventId": {
              ".write": "auth != null && auth.token.email_verified == true &&
                         root.child('list/users/'+$emailId).val() === auth.token.email",
              "eventId": { ".validate": "newData.val() === $eventId" },
              "$other": { ".validate": false }
            }
          },
          "perso": {
            ".read": "auth != null && auth.token.email_verified == true &&
                      root.child('list/users/'+$emailId).val() === auth.token.email",
            "$eventId": {
              ".write": "auth != null && auth.token.email_verified == true &&
                         root.child('list/users/'+$emailId).val() === auth.token.email",

              "id": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "title": { ".validate": "newData.isString() && newData.val().length <= 50" },
              "start": { ".validate": "newData.isNumber()" },
              "end": { ".validate": "newData.isNumber()" },
              "location": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "type": { ".validate": "newData.isString() && newData.val().length <= 30" },

              "$other": { ".validate": false }
            }
          },
          "$other": { ".validate": false }
        }
      },

      "$other": { ".validate": false }
    },
    "events": {
      "com-resps": {
        ".read": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                   auth.token.email === root.child('admin/private/admins/admin2').val() ||
                   auth.token.email === root.child('admin/private/admins/admin3').val() ||
                   root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/events-admin').val() == true ||
                   root.child('events/com-resps/resps/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists()) &&
                  auth != null && auth.token.email_verified == true",
        ".write": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                    auth.token.email === root.child('admin/private/admins/admin2').val() ||
                    auth.token.email === root.child('admin/private/admins/admin3').val() ||
                    root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/events-admin').val() == true) &&
                   auth != null && auth.token.email_verified == true",
        "groups": {
          "$groupId": {
            "groupId": { ".validate": "newData.isString() && newData.val().length <= 30" },
            "displayName": { ".validate": "newData.isString() && newData.val().length <= 30" }
          }
        },
        "resps": {
          "$emailId": {
            "emailId": { ".validate": "newData.val() === $emailId || !newData.exists()" },
            "groupId": { ".validate": "root.child('events/com-resps/groups/'+newData.val()).exists()" }
          }
        },

        "$other": { ".validate": false }
      },
      "events": {
        ".read": "auth != null && auth.token.email_verified == true",

        "$eventId": {
          ".write": "auth != null && auth.token.email_verified == true &&
                     (root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/events-admin').val() == true ||
                      root.child('events/com-resps/resps/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists()) &&
                     (root.child('events/com-resps/resps/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/groupId').val() === newData.child('groupId').val() ||
                      !newData.exists())",
          ".indexOn": ["start"],

          "id": { ".validate": "newData.val() === $eventId" },
          "title": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "description": { ".validate": "newData.isString() && newData.val().length <= 2000" },
          "image": { ".validate": "newData.isString() && newData.val().length <= 500" },
          "start": { ".validate": "newData.isNumber()" },
          "end": { ".validate": "newData.isNumber()" },
          "location": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "price": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "groupId": {
            ".validate": "root.child('events/com-resps/resps/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/groupId').val() === data.val() ||
                          !data.exists()"
          },

          "$other": { ".validate": false }
        }
      },

      "$other": { ".validate": false }
    },
    "vote": {
      "assessors": {
        ".read": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                   auth.token.email === root.child('admin/private/admins/admin2').val() ||
                   auth.token.email === root.child('admin/private/admins/admin3').val() ||
                   root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true ||
                   root.child('vote/assessors/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists()) &&
                  auth != null && auth.token.email_verified == true",
        ".write": "(auth.token.email === root.child('admin/private/admins/admin1').val() ||
                    auth.token.email === root.child('admin/private/admins/admin2').val() ||
                    auth.token.email === root.child('admin/private/admins/admin3').val() ||
                    root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true) &&
                   auth != null && auth.token.email_verified == true",

        "$emailId": {
          "emailId": { ".validate": "newData.val() === $emailId || !newData.exists()" },
        }
      },
      "polls": {
        ".read": "auth != null && auth.token.email_verified == true",
        ".write": "auth != null && auth.token.email_verified == true &&
                   root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true",

        "$poll_id": {
          ".validate": "newData.hasChildren(['title', 'description'])",

          "id": { ".validate": "newData.val() === $poll_id" },
          "title": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "description": { ".validate": "newData.isString() && newData.val().length <= 500" },
          "started": { ".validate": "newData.isBoolean()" },
          "choices": {
            "$choice_id": {
              ".validate": "newData.hasChildren(['id', 'label'])",

              "id": { ".validate": "newData.val() === $choice_id" },
              "label": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "short": { ".validate": "newData.isString() && newData.val().length <= 30" },
              "image": { ".validate": "newData.isString() && newData.val().length <= 30" },

              "$other": { ".validate": false }
            }
          },

          "$other": { ".validate": false }
        },
      },
      "votes": {
        "$poll_id": {
          ".read": "auth != null && auth.token.email_verified == true &&
                    (root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true ||
                     root.child('vote/assessors/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists())",
          ".write": "auth != null && auth.token.email_verified == true &&
                     root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true &&
                     !newData.exists()",
          ".validate": "root.child('vote/polls/'+$poll_id).exists()",

          "$emailId": {
            ".write": "auth != null && auth.token.email_verified == true &&
                       root.child('vote/assessors/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists() &&
                       root.child('vote/polls/'+$poll_id+'/started').val() == true",
            ".validate": "newData.hasChildren(['emailId', 'voted'])",

            "emailId": {
              ".write": "auth != null && auth.token.email_verified == true &&
                         root.child('list/users/'+$emailId).val() === auth.token.email &&
                         root.child('vote/polls/'+$poll_id+'/started').val() == true",
              ".validate": "newData.val() === $emailId"
            },
            "voted": {
              ".write": "auth != null && auth.token.email_verified == true &&
                         root.child('list/users/'+$emailId).val() === auth.token.email &&
                         root.child('vote/polls/'+$poll_id+'/started').val() == true &&
                         (!data.exists() || data.val() != true) && newData.val() == true",
              ".validate": "newData.isBoolean()"

            },

            "$other": { ".validate": false }
          }
        },
      },
      "results": {
        "$poll_id": {
          ".write": "auth != null && auth.token.email_verified == true &&
                     root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true &&
                     !newData.exists()",
          ".validate": "root.child('vote/polls/'+$poll_id).exists()",

          "buffer": {
            "$emailId": {
              ".write": "auth != null && auth.token.email_verified == true &&
                         root.child('list/users/'+$emailId).val() === auth.token.email &&
                         root.child('users/'+$emailId+'/'+auth.uid).exists() &&
                         (!root.child('vote/users/'+$poll_id+'/'+$emailId+'/voted').exists() ||
                          root.child('vote/users/'+$poll_id+'/'+$emailId+'/voted').val() != true) &&
                         root.child('vote/polls/'+$poll_id+'/started').val() == true &&
                         !data.exists()",
              ".validate": "root.child('vote/polls/'+$poll_id+'/choices/'+newData.val()).exists()"
            }
          },
          "ballot_box": {
            ".read": "auth != null && auth.token.email_verified == true &&
                      root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true &&
                      root.child('vote/polls/'+$poll_id+'/started').val() == false",
            "$choice_id": {
              ".validate": "root.child('vote/polls/'+$poll_id+'/choices/'+$choice_id).exists()",
              "$paper": { ".validate": "!data.exists() && (newData.val() == true)"}
            }
          },

          "$other": { ".validate": false }
        }
      },
      "users": {
        "$emailId": {
          "votes": {
            ".read": "auth != null && auth.token.email_verified == true &&
                      root.child('list/users/'+$emailId).val() === auth.token.email",
            "$poll_id": {
              ".write": "auth != null && auth.token.email_verified == true &&
                         (root.child('list/users/'+$emailId).val() === auth.token.email ||
                          root.child('vote/assessors/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists()) &&
                         root.child('vote/polls/'+$poll_id+'/started').val() == true",
              ".validate": "root.child('vote/polls/'+$poll_id).exists() &&
                            newData.isBoolean() && newData.val() == true"
            }
          },
          "$other": { ".validate": false }
        }
      },

      "$other": { ".validate": false }
    },
    "list": {
        "update": { ".validate": "newData.isNumber()" },
        "users": {
            ".read": "auth != null && auth.token.email_verified == true &&
                      (auth.token.email === root.child('admin/private/admins/admin1').val() ||
                       auth.token.email === root.child('admin/private/admins/admin2').val() ||
                       auth.token.email === root.child('admin/private/admins/admin3').val() ||
                       root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/vote-admin').val() == true ||
                       root.child('users/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')+'/'+auth.uid+'/admin/cafet-admin').val() == true) ||
                       root.child('vote/assessors/'+auth.token.email.replace('@ensimag.fr', '').replace('.', '|')).exists()",
            "$emailId": { ".validate": "newData.isString() && newData.val().length <= 50" }
        }
    },

    "$other": { ".validate": false }
  }
}
